
```{r}
library(ncvreg)
library(caret)
load("/proj/jjyehlab/users/tylerben/mystic/Source_data/TCGA_X_DWMC1.1_07082022.RData")
load("/proj/jjyehlab/users/tylerben/mystic/Generated_data/TCGA_Y_DWMC1.1_07082022_refactor.RData")
load("/proj/jjyehlab/users/tylerben/mystic/Source_data/bailey_X_DWMC1.1_07112022.RData")
load("/proj/jjyehlab/users/tylerben/mystic/Generated_data/bailey_Y_DWMC1.1_07112022_refactor.RData")
load("/proj/jjyehlab/users/tylerben/mystic/Models/model1_ktsp.RData")
```

```{r}
modell <- kTSP_01042023_model2
# modell <- kTSP_12212022

ind_fun = function(train_sub, classifier){
  indmat = matrix(-1, ncol(train_sub), nrow(classifier$TSPs))
  for(i in 1:nrow(classifier$TSPs)){
    p1 = which(rownames(train_sub) == classifier$TSPs[i,1])
    p2 = which(rownames(train_sub) == classifier$TSPs[i,2])
    indmat[,i] = (train_sub[p1,] > train_sub[p2,])^2
  }
  indmat = t(indmat)
  #rownames(indmat) = apply(classifier$TSPs, 1, paste)
  colnames(indmat) = colnames(train_sub)
  return(indmat)
}

names <- c("p1","p2","p3","p4","p5","p6","p7","p8","p9","p10")[1:nrow(modell$TSPs)]
TCGA_ind <- ind_fun(X_SSC,modell)
bailey_ind <- ind_fun(bailey_X_SSC,modell)
rownames(TCGA_ind) <- names
rownames(bailey_ind)<- names
# Y_SSC <- relevel(Y_SSC,ref = "0")
```

```{r}
# specify range for alpha using training set data
alphas = c(0.001, 0.01, 0.05, 0.25, 0.5, 0.75, 0.9, 1)

# vector to hold cross validated PE
pe = rep(NA, length(alphas))

for(i in seq_along(alphas)){

  # fit model with alpha value
  cvfit <- suppressWarnings(cv.ncvreg(X = t(TCGA_ind), y = Y_SSC,
                                      nfolds = length(Y_SSC),
                                      family='binomial', alpha = alphas[i]))
  
  # get cross-validated prediction error on training set
  pe[i] = cvfit$pe[cvfit$min]
  
}
```


```{r}
# rerun model with best alpha
cvfit <- cv.ncvreg(X = t(TCGA_ind), y = Y_SSC, nfolds = 100, family='binomial', 
                   alpha = alphas[which.min(pe)])

# save model
save(cvfit, file="/proj/jjyehlab/users/tylerben/mystic/Models/model1_PLR.RData")
```

```{r}
summary(cvfit)
plot(cvfit)
```


```{r}
## apply to test set
preds <- predict(object=cvfit, X=t(bailey_ind), type="response",
                 lambda=cvfit$lambda.min)
preds
# get calls
calls_basal <- factor(ifelse(preds>0.5,1,0), levels = c(0,1))
calls_basal
# estimate kappa on training set
# bailey_Y_SSC <- relevel(bailey_Y_SSC,ref = "0")
cf <- confusionMatrix(calls_basal, bailey_Y_SSC, positive = "1")
cf
```

```{r}

```

